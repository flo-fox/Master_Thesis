---
author: "Florian Fox"
date: "`r Sys.Date()`"
title: 'Master Thesis: A Causal Test of the Law of 1/n and its Mechanisms -- Descriptive Statistics'
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
---

# Load data and packages

```{r Packages}
library(tidyverse)
library(reshape2)
library(xtable)
source("functions.R")
```

```{r Data}
data <-
  readRDS("data/gemeinderatswahlen_alldata.rds")
```

```{r}
# similar data set definition as in "Analysis.Rmd"
d_rdd_bivariate <- data %>%
  select(ln_gross_expenditure_pc, total_seats, inhabs_rel_to_cutoff, above_cutoff, inhabitants_treshold, year, ags, election_year, state, closest, exact_pop, kreisfreie_stadt, by_law_seats) %>%
  drop_na(ln_gross_expenditure_pc, total_seats, inhabs_rel_to_cutoff)
```

```{r Options}
options(scipen = 20)
theme_set(theme_minimal())
```



# First look at the data

```{r First look}
glimpse(data)
```

# Univariate statistics

## NAs

```{r}
data %>%
  summarize(across(.cols = everything(),
                   .fns = ~sum(is.na(.))/n()
                   ))
data %>%
  group_by(state) %>%
  summarize(across(.cols = everything(),
                   .fns = ~sum(is.na(.))/n()
                   ))
data %>%
  group_by(year) %>%
  summarize(across(.cols = everything(),
                   .fns = ~sum(is.na(.))/n()
                   ))
data %>%
  group_by(state, year) %>%
  summarize(across(.cols = everything(),
                   .fns = ~sum(is.na(.))/n()
                   ))
```


## Numeric variables

```{r Univariate stats}
dim(data)
data %>%
  summarize(
    across(
      where(is.numeric),
      summarize2
    )
  ) %>%
  mutate(Stat = sum_stats,
         .before = No)
```


## Export to LaTeX

Exporting ta table of descriptive univariate statistics to LaTeX to use it in the paper.

```{r}
univar_descriptives <- data %>%
  select(ln_gross_expenditure_pc, total_seats, inhabs_rel_to_cutoff, inh_tot, exact_pop) %>%
  summarize(across(
    everything(), summarize2
  )) %>%
  mutate(
    Stat = c("Min.", "1st Quar.", "Median", "3rd Quar.", "Max.", "Mean", "S. D.", "Number of unique values", "n", "Missings"),
    .before = 1
    ) %>%
  filter(!(Stat %in% c("Number of unique values", "Missings"))) %>%
  rename(
    `Ln of gross expenditure p. c.` = ln_gross_expenditure_pc,
    `Council size` = total_seats,
    `Running variable` = inhabs_rel_to_cutoff,
    `Population (as of 12-31)` = inh_tot,
    `Population (for coun. size)` = exact_pop
  ) %>%
  pivot_longer(-Stat, names_to = "Statistic") %>%
  pivot_wider(names_from = Stat, values_from = value)
univar_descriptives
print(xtable::xtable(univar_descriptives, digits = c(rep(2, times = 9), 0)),
      file = "tables/descriptives.tex",
      booktabs = TRUE, floating = FALSE,
      include.rownames = FALSE)
```

Further (descriptive) information mentioned in the paper:

Correlation of Bavarian council size:

```{r}
cor(data$total_seats, data$total_seats_24_y_ago, use = "pairwise.complete.obs")
```

Distance between population (cutoff) date for determining council size and the actual election date:

```{r}
summary(data$time_elec_pop_diff)
```




## Factors


```{r}
data %>%
  select(-where(is.numeric), -starts_with("ags"), -town) %>%
  sapply(., function(x) table(x, useNA = "always"))
```

# Bivariate descriptive statistics



Display correlation between standard council size (as determined (by me) by council size) with actual number of seats. (On the overall sample `data`:) Especially weak in Baden-WÃ¼rttemberg, North-Rhine Westphalia, and Saxony. Strong in Saarland (sharp design here), Thuringia, and Brandenburg (though few data points here).

```{r, rows.print=15}
data %>%
  group_by(state) %>%
  summarize(n = n(), seat_cor = cor(total_seats, by_law_seats, use = "pairwise.complete.obs")) %>%
  arrange(seat_cor)
# Main data set used in analysis
d_rdd_bivariate %>%
  group_by(state) %>%
  summarize(n = n(), seat_cor = cor(total_seats, by_law_seats, use = "pairwise.complete.obs")) %>%
  arrange(seat_cor)
cor(d_rdd_bivariate$total_seats, d_rdd_bivariate$by_law_seats, use = "pairwise.complete.obs")
# Main data set used in analysis & close to cutoffs
d_rdd_bivariate %>%
  filter(closest <= 0.1) %>%
  group_by(state) %>%
  summarize(n = n(), seat_cor = cor(total_seats, by_law_seats, use = "pairwise.complete.obs")) %>%
  arrange(seat_cor)
cor(d_rdd_bivariate %>% filter(closest <= 0.1) %>% pull(total_seats),
    d_rdd_bivariate %>% filter(closest <= 0.1) %>% pull(by_law_seats),
    use = "pairwise.complete.obs")
```


```{r}

```

